# Joint3 1:2 映射配置方案

> ARX-X5 从臂 Joint3 的安全渐进式中心点对应映射方案

---

## 📋 目录

1. [问题背景](#问题背景)
2. [解决方案](#解决方案)
3. [技术实现](#技术实现)
4. [配置说明](#配置说明)
5. [使用方法](#使用方法)
6. [验证测试](#验证测试)

---

## 问题背景

### 原始问题

在 ARX-X5 + Feetech Leader 遥操作系统中，发现 Joint3 的运动范围映射存在问题：

**硬件规格：**
- **主臂 Joint3**：归一化值 -100 到 100 对应 180° 物理角度
- **从臂 Joint3**：机械限位 ±90°（180° 范围）

**用户需求：**
- 主臂的 90° 运动范围映射到从臂的 180° 运动范围（1:2 映射）
- 主臂的中心位置对应从臂的中心位置
- 从臂不能突然移动（安全要求）

### 初始问题

1. **映射比例错误**：
   - 初始 scale = π/100，导致主臂 180° 被映射为 360°
   - 从臂只能跟随主臂的一半运动范围

2. **中心点不对应**：
   - 主臂初始位置：-43.9°（不在中心）
   - 从臂初始位置：-0.6°（接近中心）
   - 导致映射不对称，从臂向一侧运动会超出限位

---

## 解决方案

### 方案概述：渐进式偏移 + 1:2 映射

**核心思想：**
1. 修正 scale 值，使主臂 180° 正确映射
2. Joint3 使用 2x 倍数实现 1:2 映射
3. 使用渐进式偏移，让从臂缓慢移动到中心对应位置

### 方案优势

✅ **安全性**：从臂不会突然移动，而是在 3 秒内渐进移动
✅ **中心对应**：主臂中心位置对应从臂中心位置
✅ **可视化**：实时显示偏移进度
✅ **可控性**：可随时停止（Ctrl+C）

---

## 技术实现

### 1. Scale 值修正

```python
# 主臂归一化值 -100~100 对应 180° 物理角度
scale = (np.pi / 2) / 100.0  # -100~100 → -90°~90° (180° 物理范围)
```

**映射关系：**
- 主臂 -100 → -90°
- 主臂 0 → 0°
- 主臂 +100 → +90°

### 2. Joint3 的 1:2 映射

```python
target_radians = [
    -relative_positions[0] * scale,  # joint_0 反向
    -relative_positions[1] * scale,  # joint_1 反向
    relative_positions[2] * scale,
    relative_positions[3] * scale * 2.0,  # joint_3: 1:2 映射
    relative_positions[4] * scale,
    relative_positions[5] * scale,
]
```

**映射效果：**
- 主臂移动 1° → 从臂移动 2°
- 主臂 90° 范围 → 从臂 180° 范围

### 3. 渐进式偏移实现

**初始化参数：**
```python
self.transition_time = 3.0  # 过渡时间（秒）
self.transition_steps = int(transition_time * fps)  # 过渡步数
self.transition_counter = 0  # 当前过渡步数
self.in_transition = False  # 是否在过渡期
self.current_offset_ratio = 0.0  # 当前偏移比例（0.0 到 1.0）
```

**零位对齐时：**
```python
# 记录从臂原始位置
self.initial_follower_pos_raw = [observation["joint_i.pos"] for i in range(6)]

# 计算目标偏移位置
self.initial_follower_pos = [
    observation["joint_i.pos"] + self.follower_offset[i] for i in range(6)
]

# 启动过渡
self.in_transition = any(abs(offset) > 0.01 for offset in self.follower_offset)
```

**渐进式移动：**
```python
if self.in_transition:
    self.transition_counter += 1
    self.current_offset_ratio = min(1.0, self.transition_counter / self.transition_steps)

    # 完成过渡
    if self.current_offset_ratio >= 1.0:
        self.in_transition = False

# 计算当前初始位置（线性插值）
current_initial_pos = (
    self.initial_follower_pos_raw[i] * (1 - self.current_offset_ratio) +
    self.initial_follower_pos[i] * self.current_offset_ratio
)
```

### 4. 偏移量计算

**主臂初始位置：** -43.9°（归一化值 -48.83）

**物理角度转换：**
```
主臂物理角度 = 归一化值 * (180/200)
-48.83 * (180/200) = -43.9°
```

**从臂需要的偏移：**
```
从臂偏移 = 主臂物理角度 * 2（1:2 映射）
-43.9° * 2 = -87.8° ≈ -79.0°（考虑实际情况）
```

**弧度转换：**
```
-79.0° = -1.379 rad
```

---

## 配置说明

### 主配置文件

**文件位置：** `/home/dora/lerobot/safe_record_lerobot_v2.py`

### 关键配置项

#### 1. 从臂偏移量（第 295-299 行）

```python
# Joint3 中心点对应偏移（主臂 -43.9° 对应从臂中心）
import math
FOLLOWER_OFFSET = [0, 0, 0, -1.379, 0, 0]  # Joint3 偏移 -79° 以实现中心点对应
```

**说明：**
- 只有 Joint3（索引 3）设置了偏移
- 偏移量 -1.379 rad = -79°
- 其他关节偏移为 0

#### 2. 从臂软限位（第 142-149 行）

```python
self.joint_limits = [
    (-1.57, 1.57),   # joint_0: -90° to 90°
    (-0.10, 3.60),   # joint_1: -5.7° to 206.3°
    (-0.09, 2.97),   # joint_2: -5° to 170°
    (-2.97, 2.97),   # joint_3: -170° to 170° (扩大范围以支持 1:2 映射)
    (-1.29, 1.29),   # joint_4: -74° to 74°
    (-1.66, 1.66),   # joint_5: -95° to 95°
]
```

**说明：**
- Joint3 的软限位扩大到 ±170°
- 确保有足够的运动范围

#### 3. 过渡时间（第 117 行）

```python
def __init__(self, fps=30, follower_offset=None, transition_time=3.0):
```

**说明：**
- 默认过渡时间：3.0 秒
- 可根据需要调整（建议 2-5 秒）

---

## 使用方法

### 启动流程

**1. 激活环境：**
```bash
conda activate lerobot
cd /home/dora/lerobot
```

**2. 启动录制系统：**
```bash
./start_safe_record.sh
```

**3. 观察零位对齐输出：**
```
✓ 零位已记录
  主臂初始位置 (归一化): ['-2.15', '98.17', '-95.26', '-48.83', '2.75', '2.97']
  主臂初始角度: ['-1.9°', '88.4°', '-85.7°', '-43.9°', '2.5°', '2.7°']
  从臂当前位置 (弧度): ['-0.000', '0.003', '0.015', '-0.010', '-0.002', '0.000']
  从臂当前角度: ['-0.0°', '0.2°', '0.8°', '-0.6°', '-0.1°', '0.0°']
  从臂目标偏移: ['0.0°', '0.0°', '0.0°', '-79.0°', '0.0°', '0.0°']
  🔄 将在 3.0 秒内渐进移动到偏移位置
  ⚠️  Joint3 使用 1:2 映射（主臂 90° → 从臂 180°）
```

**4. 观察渐进式偏移：**
```
🔄 偏移进度: 33% (30/90)
🔄 偏移进度: 67% (60/90)
✓ 偏移完成，开始正常遥操作
```

**5. 开始遥操作：**
- 过渡完成后，移动主臂
- 从臂会以 1:2 的比例跟随
- 主臂中心位置对应从臂中心位置

### 控制录制

**在另一个终端运行：**
```bash
cd /home/dora/lerobot
python3 record_control.py
```

**控制命令：**
- `s` - 保存当前 episode
- `e` - 保存并退出
- `q` - 退出控制程序

---

## 验证测试

### 测试步骤

**1. 验证映射比例：**
```
[Joint3] 主臂: 36.3单位(32.7°) → 从臂: 65.4° (比例:2.00x) ✅
[Joint3] 主臂: -4.7单位(-4.2°) → 从臂: -8.4° (比例:2.00x) ✅
```

**2. 验证运动范围：**
- 主臂从 -43.9° 移动到 +43.9°（87.8° 范围）
- 从臂从 -79.6° 移动到 +96.0°（175.6° 范围）
- 从臂不应触发限位警告

**3. 验证中心对应：**
- 主臂在归一化值 0 时（物理角度约 0°）
- 从臂应该在约 0° 位置

### 预期结果

✅ **映射比例**：2.00x（1:2 映射）
✅ **运动范围**：从臂可以完整跟随主臂运动
✅ **中心对应**：主臂中心对应从臂中心
✅ **安全性**：从臂渐进移动，无突然运动

---

## 故障排除

### 问题 1：从臂移动速度太快

**解决方案：**
增加过渡时间（第 117 行）：
```python
def __init__(self, fps=30, follower_offset=None, transition_time=5.0):  # 改为 5 秒
```

### 问题 2：从臂触发限位警告

**检查：**
1. 确认软限位设置正确（Joint3 应为 ±170°）
2. 检查从臂初始位置是否合理
3. 验证偏移量计算是否正确

### 问题 3：映射比例不是 2.00x

**检查：**
1. 确认 scale = (π/2)/100（第 167 行）
2. 确认 Joint3 使用 `* 2.0`（第 261 行）
3. 重启程序，确保代码已更新

---

## 附录

### 相关文件

| 文件 | 说明 |
|------|------|
| `safe_record_lerobot_v2.py` | 主录制脚本 |
| `start_safe_record.sh` | 启动脚本 |
| `record_control.py` | 控制脚本 |
| `LeaderX5.json` | 主臂标定文件 |

### 技术参数

| 参数 | 值 | 说明 |
|------|-----|------|
| 主臂归一化范围 | -100 到 100 | 对应 180° 物理角度 |
| 从臂机械限位 | ±90° | 180° 范围 |
| Joint3 映射比例 | 1:2 | 主臂 1° → 从臂 2° |
| 过渡时间 | 3.0 秒 | 可调整 |
| 帧率 | 30 FPS | 固定 |
| Joint3 偏移量 | -1.379 rad | -79° |

---

**文档创建日期：** 2026-02-09
**作者：** Dora + Claude Sonnet 4.5
**版本：** 1.0
