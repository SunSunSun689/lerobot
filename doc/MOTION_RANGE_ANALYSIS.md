# 从臂与主臂运动范围对比

## 1. 主臂（Feetech Leader - STS3215）

### 电机规格

- **型号**: STS3215
- **分辨率**: 4096 (12-bit)
- **输出范围**: -100 到 +100 (归一化值)

### 关节实际运动范围

| 关节    | 实际使用范围 | 备注               |
| ------- | ------------ | ------------------ |
| joint_0 | **±90°**     | 与从臂软件限位一致 |
| joint_1 | ±96°         | 略小于从臂范围     |
| joint_2 | ±85°         | 略小于从臂范围     |
| joint_3 | ±46°         | 小于从臂范围       |
| joint_4 | ±96°         | 可覆盖从臂范围     |
| joint_5 | ±104°        | 可覆盖从臂范围     |

**注意**: 虽然标定文件显示更大的范围，但实际使用中 joint_0 的范围限制为 ±90°，与从臂软件限位匹配。

---

## 2. 从臂（ARX-X5 Follower）

### 关节限位（官方规格）

| 关节    | 软件限位 (rad) | 软件限位 (°)       | 机械限位 (°) | 安全裕度  |
| ------- | -------------- | ------------------ | ------------ | --------- |
| joint_0 | -1.57 ~ 1.57   | **-90° ~ 90°**     | -150° ~ 180° | 60°~90°   |
| joint_1 | -0.10 ~ 3.60   | **-5.7° ~ 206.3°** | 0° ~ 210°    | 5.7°~3.7° |
| joint_2 | -0.09 ~ 2.97   | -5° ~ 170°         | -            | -         |
| joint_3 | -1.22 ~ 1.22   | -70° ~ 70°         | -            | -         |
| joint_4 | -1.40 ~ 1.40   | -80° ~ 80°         | -            | -         |
| joint_5 | -1.66 ~ 1.66   | -95° ~ 95°         | -            | -         |

**注意**:

- joint_0 和 joint_1 的软件限位比机械限位保守，确保安全
- joint_1 的软件限位设置为 -0.1 rad 是为了**防止解算失效**

### 软限位保护

代码中实现了官方软限位保护：

```python
self.joint_limits = [
    (-1.57, 1.57),   # joint_0: -90° to 90° (官方软件限位)
    (-0.10, 3.60),   # joint_1: -5.7° to 206.3° (官方软件限位，防止解算失效)
    (-0.09, 2.97),   # joint_2: -5° to 170°
    (-1.22, 1.22),   # joint_3: -70° to 70°
    (-1.40, 1.40),   # joint_4: -80° to 80°
    (-1.66, 1.66),   # joint_5: -95° to 95°
]
```

---

## 3. 运动范围对比

### 主臂 vs 从臂

| 关节    | 主臂理论范围 | 从臂实际范围        | 是否匹配    | 备注         |
| ------- | ------------ | ------------------- | ----------- | ------------ |
| joint_0 | ±180°        | -140° ~ 170° (310°) | ⚠️ 超出     | 从臂范围更大 |
| joint_1 | ±180°        | -5° ~ 200° (205°)   | ⚠️ 超出     | 从臂范围更大 |
| joint_2 | ±180°        | -5° ~ 170° (175°)   | ✅ 接近     | 基本匹配     |
| joint_3 | ±180°        | -70° ~ 70° (140°)   | ✅ 主臂更大 | 从臂受限     |
| joint_4 | ±180°        | -80° ~ 80° (160°)   | ✅ 主臂更大 | 从臂受限     |
| joint_5 | ±180°        | -95° ~ 95° (190°)   | ✅ 接近     | 基本匹配     |

### 关键发现

1. **joint_0 和 joint_1**: 从臂的运动范围**超过 180°**，但主臂理论上只能提供 ±180° 的输入
   - 这意味着主臂无法完全利用从臂的全部运动范围
   - 实际使用中，从臂的运动会被限制在主臂能提供的范围内

2. **joint_3 和 joint_4**: 从臂的运动范围**小于主臂**
   - 主臂可以提供更大的输入，但从臂会被软限位保护限制
   - 当主臂超出从臂范围时，会触发限位警告

3. **相对位置控制**: 当前使用零位对齐的相对位置控制
   - 主臂和从臂的初始位置被记录
   - 主臂的相对运动被映射到从臂
   - 这种方式可以避免绝对位置不匹配的问题

---

## 4. 映射关系

### 当前映射公式

```python
# 主臂读取值: -100 到 +100
scale = π / 100.0  # 0.0314 rad/unit

# 相对位置计算
relative_position = current_leader_pos - initial_leader_pos

# 转换为弧度（joint_1 反向）
target_radians[0] = relative_position[0] * scale
target_radians[1] = -relative_position[1] * scale  # 反向
target_radians[2] = relative_position[2] * scale
target_radians[3] = relative_position[3] * scale
target_radians[4] = relative_position[4] * scale
target_radians[5] = relative_position[5] * scale

# 应用到从臂（加上初始位置）
follower_target = initial_follower_pos + filtered(target_radians)

# 软限位保护
final_position = clamp(follower_target, joint_limits)
```

### 映射比例

- **主臂移动 100 单位** = **π 弧度** (约 180°)
- **主臂移动 1 单位** = **0.0314 弧度** (约 1.8°)

---

## 5. 安全建议

### ✅ 当前安全机制

1. **零位对齐**: 避免启动时突然运动
2. **低通滤波**: 平滑运动轨迹
3. **软限位保护**: 防止超出机械限位
4. **限位警告**: 当接近限位时打印警告

### ⚠️ 注意事项

1. **joint_0 和 joint_1** 的从臂范围超过 180°，但主臂无法完全覆盖
2. **joint_3 和 joint_4** 的从臂范围较小，主臂容易触发限位
3. **joint_1 反向映射**: 需要注意运动方向

### 💡 优化建议

1. 可以调整映射比例，使主臂的全范围更好地匹配从臂的工作空间
2. 考虑为不同关节使用不同的缩放因子
3. 添加视觉或听觉反馈，提醒操作者接近限位

---

## 6. 测试建议

### 测试每个关节的实际范围

```python
# 在录制前，可以手动测试每个关节的范围
# 1. 将主臂移动到一个方向的极限
# 2. 观察从臂是否触发限位警告
# 3. 记录主臂的位置值和从臂的实际位置
# 4. 重复另一个方向
```

### 工作空间标定

建议进行工作空间标定，确定：

- 主臂舒适操作范围
- 从臂安全工作范围
- 两者的最佳映射关系
